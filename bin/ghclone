#!/bin/bash

#shellcheck source=../lib.sh
source "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/lib.sh"
require_non_root

dest_basedir="$HOME/Code"
owner_default="$(id -un)"
shallow=false

usage() {
  cat << EOF >&2
Usage: $(basename "$0") <repo>

Clones <repo> to "$dest_basedir" if it doesn't exist then prints the location.

<repo> is [owner/]<name>. If owner is not specified, "$owner_default" will be used.

OPTIONS:

  -s    Shallow clone

EXAMPLES:

ghclone bad-code
ghclone morhetz/gruvbox

EOF
}

while getopts 's' flag; do
  case "${flag}" in
    s) shallow=true ;;
    *) usage ; exit 1 ;; 
  esac
done
shift $((OPTIND-1))

repo="${1:-}"
if [[ -z "$repo" ]]; then
  usage
  exit 1
fi

name="$(basename "$repo" .git).git"
owner="$(dirname "$repo")"
if [[ "$owner" == "." ]]; then
  owner="$owner_default"
fi
url="https://github.com/$owner/$name"
dest_dir="$dest_basedir/$(basename "$url" .git)"

cmdstr="git clone"
if $shallow; then
  cmdstr="$cmdstr --depth 1"
fi
cmdstr="$cmdstr $url $dest_dir"

if [[ ! -d "$dest_dir" ]]; then
  mkdir -p "$dest_basedir"
  log_info "Cloning $url to $dest_dir..."
  if ! eval "$cmdstr" > /dev/null; then
    log_err "command failed: $cmdstr"
    exit 1
  fi
fi

echo "$dest_dir"
